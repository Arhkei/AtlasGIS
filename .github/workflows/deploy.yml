name: Deploy To AWS

on:
  push:
    branches: [ deploy ]
  pull_request:
    branches: [ deploy ]

jobs:
  cluster:
    name: Deploy stack to AWS
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Configure AWS credentials
      id: creds
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Set Team id
      run: |
        TEAM_ID=${GITHUB_REPOSITORY##*-}
        echo "Team number: ${TEAM_ID}"
        echo "::set-env name=TEAM_ID::${TEAM_ID}"
    
    - name: Pack Key
      run: |
        GSK="${{ secrets.GIT_SSH_PRIVATE_KEY }}"
        GSK_PACKED=$(echo "$GSK" | base64 -w0)
        echo "::set-env name=GSK_PACKED::${GSK_PACKED}"
      
    - name: Deploy docker-compose stack
      id: ec2-compose
      uses: aws-actions/aws-cloudformation-github-deploy@v1
      with:
        name: ec2-deploy
        template: aws/deploy.template
        no-fail-on-empty-changeset: "1"
        parameter-overrides: "GITSSHKEY=${{ env.GSK_PACKED }}, GITHUBREPO=${{ github.repository }}"